---
- name: 'Fetch solr patch with {{ solr_patch_transport }} transport'
  include_tasks: '{{ transport_driver }}'
  with_first_found:
    - '../win_fetch/{{ solr_patch_transport }}.yml'
    - '../fetch/unknown-transport.yml'
  loop_control:
    loop_var: transport_driver

- name: Copy contrib and data hybris components
  win_copy:
    src: '{{ hybris_patch_file }}'
    dest: '{{ solr_dest_main_path }}/'
    force: True
    remote_src: True
  loop:
    - '{{ solr_contrib_hybris_patch }}'
    - '{{ solr_data_hybris_patch }}'
  loop_control:
    loop_var: hybris_patch_file

- name: Create data temporary directories
  win_tempfile:
    state: directory
    suffix: solr_hybris_data
  register: hybris_solr_data_temp_dir
  changed_when: False

- name: Create contrib temporary directories
  win_tempfile:
    state: directory
    suffix: solr_hybris_contrib
  register: hybris_solr_contrib_temp_dir
  changed_when: False

- name: Unzip data hybris components
  win_unzip:
    src: '{{ solr_data_hybris_patch }}'
    dest: '{{ hybris_solr_data_temp_dir.results.path }}'

- name: Unzip contrib hybris components
  win_unzip:
    src: '{{ solr_contrib_hybris_patch }}'
    dest: '{{ hybris_solr_contrib_temp_dir.results.path }}'

- name: Copy data components
  win_robocopy:
    src: '{{ hybris_solr_data_temp_dir.results.path }}'
    dest: '{{ solr_dest_path }}/server'
    recurse: True
    purge: True
  notify: restart Solr Windows

- name: Copy contrib components
  win_robocopy:
    src: '{{ hybris_solr_contrib_temp_dir.results.path }}'
    dest: '{{ solr_dest_path }}'
    recurse: True
    purge: True
  notify: restart Solr Windows

- name: start Solr Windows
  win_service:
    name: '{{ solr_service_name }}'
    state: started
  when:
    - solr_service_start
